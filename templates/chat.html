{% extends "base.html" %}
{% block content %}
<h2>AI Chat Assistant</h2>
<p class="chat-subtitle">Talk about your career — I'm listening!</p>

<div class="chat-container">
  <div class="chat-messages" id="messages">
    {% for msg in chat_history %}
      <div class="message {{ 'user-message' if msg.sender == 'user' else 'bot-message' }}">
        <div class="message-content">
          {% if msg.sender == 'user' %}
            {{ msg.text|safe }}
          {% else %}
            <div class="pretty-bot" data-raw="{{ msg.text }}"></div>
          {% endif %}
        </div>
      </div>
    {% endfor %}
  </div>

  <form method="POST" class="chat-form" id="chatForm" enctype="multipart/form-data">
    <div class="chat-input-group">
      <input type="text" name="message" placeholder="Type a message..." autocomplete="off" autofocus>
      
      <input type="file" name="file" id="fileInput" accept=".pdf,.docx" style="display:none;">

      <div class="chat-actions">
        <button type="button" class="chat-attach-btn" onclick="document.getElementById('fileInput').click();" title="Attach PDF or DOCX">
          <i class="fa-solid fa-paperclip"></i>
        </button>
        <button type="submit" class="chat-send-btn">
          <i class="fa-solid fa-paper-plane"></i>
        </button>
      </div>
    </div>
  </form>
</div>

<style>
  .chat-input-group { display:flex; align-items:center; gap:8px; }
  .chat-actions { display:flex; gap:8px; }
  .chat-attach-btn {
    background: #e2e8f0;
    color: #475569;
    border: none;
    border-radius: 50%;
    width: 48px;
    height: 48px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.2em;
    cursor: pointer;
    transition: all .2s;
  }
  .chat-attach-btn:hover { background: #cbd5e1; }
  
  .pretty-bot pre {
    background: #f6f8fa; padding: 12px; border-radius: 6px; overflow-x: auto;
    margin: 8px 0;
  }
  .pretty-bot code {
    font-family: 'Consolas', 'Monaco', monospace;
  }
</style>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    marked.setOptions({
      highlight: function(code, lang) {
        if (lang && hljs.getLanguage(lang)) {
          try { return hljs.highlight(code, { language: lang }).value; }
          catch (_) {}
        }
        return hljs.highlightAuto(code).value;
      },
      breaks: true,
      gfm: true
    });

    document.querySelectorAll('.pretty-bot').forEach(el => {
      const rawText = el.getAttribute('data-raw') || '';
      if (rawText) {
        el.innerHTML = marked.parse(rawText);
      }
    });

    const messages = document.getElementById('messages');
    messages.scrollTop = messages.scrollHeight;
  });

  const form = document.getElementById('chatForm');
  const msgInput = form.querySelector('input[name="message"]');
  const fileInput = document.getElementById('fileInput');

  // ENTER KEY → submit form
  msgInput.addEventListener('keydown', e => {
    if (e.key === 'Enter' && !e.shiftKey) {
      e.preventDefault();
      form.submit();
    }
  });

  // FILE SELECTED → do NOT modify input text, just keep file
  fileInput.addEventListener('change', () => {
    // Do nothing with the text input — file will be sent via form
    // Optional: give visual feedback (e.g. change button color)
    const attachBtn = document.querySelector('.chat-attach-btn');
    if (fileInput.files.length > 0) {
      attachBtn.style.background = '#2563eb';
      attachBtn.style.color = 'white';
      attachBtn.innerHTML = '<i class="fa-solid fa-check"></i>';
    } else {
      attachBtn.style.background = '#e2e8f0';
      attachBtn.style.color = '#475569';
      attachBtn.innerHTML = '<i class="fa-solid fa-paperclip"></i>';
    }
  });

  // Optional: Reset button on form submit
  form.addEventListener('submit', () => {
    setTimeout(() => {
      const attachBtn = document.querySelector('.chat-attach-btn');
      attachBtn.style.background = '#e2e8f0';
      attachBtn.style.color = '#475569';
      attachBtn.innerHTML = '<i class="fa-solid fa-paperclip"></i>';
      fileInput.value = ''; // clear file
    }, 100);
  });
</script>
{% endblock %}